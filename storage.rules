rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // ========== HELPER FUNCTIONS ==========

    // Verificar si el usuario es admin
    function isAdmin() {
      return request.auth != null && request.auth.token.role == 'admin';
    }

    // Verificar si el archivo es una imagen válida
    function isValidImage() {
      return request.resource.size < 10 * 1024 * 1024 // < 10MB
        && request.resource.contentType.matches('image/.*');
    }

    // Verificar si el archivo es audio válido
    function isValidAudio() {
      return request.resource.size < 50 * 1024 * 1024 // < 50MB
        && request.resource.contentType.matches('audio/.*');
    }

    // Verificar si el archivo es video válido
    function isValidVideo() {
      return request.resource.size < 100 * 1024 * 1024 // < 100MB
        && request.resource.contentType.matches('video/.*');
    }

    // ========== STORAGE BUCKETS ==========

    // Imágenes de pinturas (galería principal)
    match /paintings/{allPaths=**} {
      // Lectura pública necesaria para la galería
      allow read: if true;

      // Solo admin puede subir/eliminar (con validación de imagen)
      allow create, delete: if isAdmin() && isValidImage();
    }

    // Imágenes de pedidos personalizados (obra a pedido)
    match /custom-orders/{allPaths=**} {
      // Lectura pública (para que admin vea las refs subidas por clientes)
      allow read: if true;

      // Escritura pública CONTROLADA (formulario público, máx 10MB, solo imágenes)
      allow create: if isValidImage();

      // Solo admin puede eliminar
      allow delete: if isAdmin();
    }

    // Configuración del home (banner, hero, videos)
    match /home-settings/{allPaths=**} {
      // Lectura pública (banner/hero visible para todos)
      allow read: if true;

      // Solo admin puede modificar (validar imágenes o videos)
      allow create, update, delete: if isAdmin()
        && (isValidImage() || isValidVideo());
    }

    // Archivos de música de fondo
    match /music/{allPaths=**} {
      // Lectura pública (para reproducir en el sitio)
      allow read: if true;

      // Solo admin puede modificar (validar audio)
      allow create, update, delete: if isAdmin() && isValidAudio();
    }

    // Imágenes del blog
    match /blog/{allPaths=**} {
      // Lectura pública (posts visibles para todos)
      allow read: if true;

      // Solo admin puede modificar
      allow create, update, delete: if isAdmin() && isValidImage();
    }

    // Comprobantes de transferencia (payment proofs)
    match /payment-proofs/{orderId}/{fileName} {
      // Lectura: solo admin o usuario autenticado (para ver su propio comprobante)
      allow read: if isAdmin() || request.auth != null;

      // Escritura pública CONTROLADA (usuarios suben comprobantes, máx 5MB, solo imágenes)
      allow create: if request.resource.size < 5 * 1024 * 1024
        && request.resource.contentType.matches('image/.*');

      // Solo admin puede eliminar
      allow delete: if isAdmin();
    }

    // Bloquear cualquier otro path no explícitamente permitido
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
